# КОНСТРУКТОР ПРЕДЛОЖЕНИЙ И ЦЕПОЧЕК
## Полная механика для собственников и администраторов

**Версия:** 1.0  
**Дата:** Ноябрь 2025  

---

## СОДЕРЖАНИЕ

1. [Концепция и терминология](#концепция-и-терминология)
2. [Типы предложений](#типы-предложений)
3. [Конструктор для собственников бизнеса](#конструктор-для-собственников)
4. [Механика цепочек (кросс-промо)](#механика-цепочек)
5. [Панель администратора](#панель-администратора)
6. [База данных и API](#база-данных-и-api)
7. [Аналитика эффективности](#аналитика-эффективности)
8. [Примеры сценариев](#примеры-сценариев)

---

## КОНЦЕПЦИЯ И ТЕРМИНОЛОГИЯ

### Основные понятия

```yaml
Предложение (Offer):
  Определение: Акция, скидка, бонус или специальное условие от одного бизнеса
  Примеры:
    - "Скидка 20% на маникюр для новых клиентов"
    - "При покупке от 5000₽ - кофе в подарок"
    - "500₽ бонусов за первый визит"

Цепочка (Chain):
  Определение: Последовательность предложений от разных бизнесов
  Цель: Стимулировать переход клиента между категориями
  Пример: Лисичкино → Миндаль → Skinerica
  
  Визуализация:
  [Купил в Лисичкино] → [Получил купон на Миндаль] → [Использовал купон] → [Получил бонус в Skinerica]

Триггер (Trigger):
  Определение: Условие активации предложения
  Примеры:
    - Первая покупка в категории
    - Покупка от X рублей
    - День рождения клиента
    - N-й визит в месяц

Купон (Coupon):
  Определение: Цифровой сертификат с уникальным кодом
  Характеристики:
    - Имеет срок действия
    - Может быть одноразовым или многоразовым
    - Может иметь ограничение по сумме

Пакет (Package):
  Определение: Комбинация услуг от 2+ бизнесов по специальной цене
  Пример: "Smile & Style" = Стоматология + Салон красоты + Оптика за 15,000₽
```

### Роли пользователей

```yaml
Собственник бизнеса (Business Owner):
  Права:
    ✅ Создавать предложения для своего бизнеса
    ✅ Видеть аналитику своих предложений
    ✅ Предлагать цепочки с партнерами
    ✅ Настраивать бюджет на акции
    ❌ Создавать предложения для чужих бизнесов
    ❌ Утверждать цепочки без согласия партнера

Менеджер бизнеса (Business Manager):
  Права:
    ✅ Создавать предложения (требуют одобрения собственника)
    ✅ Активировать/деактивировать купоны
    ✅ Видеть статистику использования
    ❌ Настраивать бюджеты

Администратор платформы (Platform Admin):
  Права:
    ✅ Создавать любые предложения
    ✅ Одобрять/отклонять предложения
    ✅ Создавать системные цепочки
    ✅ Видеть всю аналитику
    ✅ Модерировать пакеты
    ✅ Настраивать глобальные правила

Сервисная служба (Support):
  Права:
    ✅ Помогать собственникам создавать предложения
    ✅ Консультировать по оптимизации цепочек
    ✅ Видеть аналитику всех бизнесов
    ❌ Редактировать без согласования
```

---

## ТИПЫ ПРЕДЛОЖЕНИЙ

### 1. Простая скидка (Simple Discount)

**Описание:** Прямое снижение цены на услугу или товар

**Параметры:**
```yaml
Тип скидки:
  - Процент (10%, 20%, 50%)
  - Фиксированная сумма (500₽, 1000₽)

Условия применения:
  - Для всех клиентов
  - Только для новых клиентов
  - Только для VIP/Elite
  - При покупке от X рублей

Ограничения:
  - Срок действия (с даты по дату)
  - Лимит использований (100 раз / безлимит)
  - Лимит на клиента (1 раз / N раз)

Комбинирование:
  - Можно совмещать с другими акциями (да/нет)
  - Можно использовать бонусы (да/нет)
```

**Пример:**
```json
{
  "offer_type": "simple_discount",
  "business_id": "uuid-mindal",
  "title": "Скидка 20% на первый маникюр",
  "description": "Для новых клиентов салона",
  "discount": {
    "type": "percentage",
    "value": 20
  },
  "conditions": {
    "new_customers_only": true,
    "min_purchase": 0,
    "status_required": "insider"
  },
  "limitations": {
    "valid_from": "2025-12-01T00:00:00",
    "valid_until": "2025-12-31T23:59:59",
    "total_uses": 100,
    "uses_per_customer": 1
  },
  "stackable": false
}
```

---

### 2. Кешбэк-бонусы (Bonus Cashback)

**Описание:** Дополнительные бонусы сверх стандартного кешбэка

**Параметры:**
```yaml
Множитель:
  - 1.5x (вместо 5% → 7.5%)
  - 2x (двойные бонусы)
  - 3x (тройные бонусы)
  - Или фиксированная сумма: +500₽

Триггеры:
  - Первая покупка в новой категории
  - Покупка в определенные часы (happy hours)
  - Определенный день недели
  - Праздничные дни
```

**Пример:**
```json
{
  "offer_type": "bonus_cashback",
  "business_id": "uuid-lisichkino",
  "title": "Тройные бонусы по средам",
  "description": "Каждую среду получайте 15% вместо 5%",
  "bonus": {
    "type": "multiplier",
    "value": 3.0
  },
  "conditions": {
    "day_of_week": [3], // Среда
    "time_from": "12:00",
    "time_to": "20:00"
  },
  "limitations": {
    "valid_from": "2025-12-01",
    "valid_until": "2026-01-31"
  }
}
```

---

### 3. Кросс-промо купон (Cross-Promo Coupon)

**Описание:** Покупка в бизнесе A → купон на бизнес B

**Параметры:**
```yaml
Источник (откуда):
  business_id: uuid-a
  trigger_amount: минимальная сумма покупки

Цель (куда):
  business_id: uuid-b
  coupon_value: сумма купона
  coupon_type: скидка / бонусы

Срок действия купона:
  expires_in_days: 10 дней с момента получения

Ограничения:
  one_time_use: одноразовый (да/нет)
  min_purchase_to_use: минимальная сумма для использования
```

**Пример:**
```json
{
  "offer_type": "cross_promo_coupon",
  "source_business_id": "uuid-lisichkino",
  "target_business_id": "uuid-mindal",
  "title": "Купон в салон за покупку в гастромаркете",
  "description": "Купили от 3000₽ в Лисичкино? Получите 500₽ на маникюр!",
  "trigger": {
    "min_purchase": 3000
  },
  "coupon": {
    "type": "fixed_discount",
    "value": 500,
    "expires_in_days": 10,
    "min_purchase_to_use": 1500
  },
  "budget": {
    "total_budget": 50000, // Лисичкино выделяет 50,000₽
    "cost_per_coupon": 500,
    "max_coupons": 100
  }
}
```

---

### 4. Пакетное предложение (Package Deal)

**Описание:** Комбинация услуг от 2+ бизнесов по специальной цене

**Параметры:**
```yaml
Состав пакета:
  - Бизнес 1: услуга X
  - Бизнес 2: услуга Y
  - Бизнес 3: услуга Z

Цена пакета:
  original_price: сумма цен по отдельности
  package_price: итоговая цена
  discount_percentage: процент скидки

Распределение выручки:
  - Бизнес 1: 40%
  - Бизнес 2: 35%
  - Бизнес 3: 25%

Срок действия:
  - Услуги должны быть использованы в течение 60 дней
```

**Пример:**
```json
{
  "offer_type": "package_deal",
  "title": "Smile & Style",
  "description": "Профчистка зубов + стрижка + подбор очков",
  "businesses": [
    {
      "business_id": "uuid-stim",
      "service": "Профессиональная чистка зубов",
      "original_price": 5000,
      "share_percentage": 40
    },
    {
      "business_id": "uuid-mindal",
      "service": "Стрижка + укладка",
      "original_price": 3500,
      "share_percentage": 35
    },
    {
      "business_id": "uuid-optika",
      "service": "Диагностика зрения + консультация",
      "original_price": 2500,
      "share_percentage": 25
    }
  ],
  "pricing": {
    "original_total": 11000,
    "package_price": 8800,
    "discount_percentage": 20
  },
  "limitations": {
    "valid_until": "2026-03-31",
    "max_sales": 50,
    "usage_period_days": 60
  }
}
```

---

### 5. Подарок при покупке (Gift with Purchase)

**Описание:** При покупке от X рублей клиент получает подарок

**Параметры:**
```yaml
Условие:
  min_purchase: минимальная сумма

Подарок:
  - Товар/услуга бесплатно
  - Сертификат партнера
  - Физический подарок

Источник подарка:
  - Свой бизнес
  - Бизнес-партнер
  - Платформа
```

**Пример:**
```json
{
  "offer_type": "gift_with_purchase",
  "business_id": "uuid-lisichkino",
  "title": "Кофе в подарок при покупке от 5000₽",
  "description": "Закажите на сумму от 5000₽ и получите латте в подарок",
  "trigger": {
    "min_purchase": 5000
  },
  "gift": {
    "type": "own_product",
    "name": "Латте",
    "cost_to_business": 250
  },
  "limitations": {
    "valid_from": "2025-12-01",
    "valid_until": "2025-12-31",
    "max_gifts": 200
  }
}
```

---

## КОНСТРУКТОР ДЛЯ СОБСТВЕННИКОВ

### UI/UX Веб-панели собственника

#### Главный экран "Мои предложения"

```
┌────────────────────────────────────────────────────────────────┐
│  Мои предложения                        [+ Создать предложение] │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Фильтры: [Все] [Активные] [Истекшие] [Черновики]             │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 🎯 Скидка 20% на первый маникюр                           │  │
│  │ Статус: ● Активна                      До: 31.12.2025    │  │
│  │                                                           │  │
│  │ 📊 Статистика:                                            │  │
│  │    Использовано: 23 / 100                                │  │
│  │    Конверсия: 45% (23 из 51 показов)                     │  │
│  │    Выручка: +34,500₽                                      │  │
│  │                                                           │  │
│  │ [Подробнее] [Редактировать] [⏸ Приостановить]            │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 🎁 Купон 500₽ в салон за покупку в Лисичкино             │  │
│  │ Статус: ⏸ На модерации                                   │  │
│  │                                                           │  │
│  │ ⚠️ Требуется согласие партнера                            │  │
│  │                                                           │  │
│  │ [Подробнее]                                               │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

---

#### Мастер создания предложения (Step-by-Step)

**ШАГ 1: Выбор типа предложения**

```
┌────────────────────────────────────────────────────────────────┐
│  Создание предложения                            Шаг 1 из 5    │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Какой тип предложения вы хотите создать?                      │
│                                                                 │
│  ┌─────────────────────────┐  ┌─────────────────────────┐      │
│  │ 💰 Простая скидка       │  │ 🎁 Бонусы              │      │
│  │                         │  │                         │      │
│  │ Снижение цены на товар  │  │ Дополнительные бонусы   │      │
│  │ или услугу              │  │ за покупку              │      │
│  │                         │  │                         │      │
│  │ Пример: -20% на маникюр │  │ Пример: 2x бонусов     │      │
│  │                         │  │                         │      │
│  │ [Выбрать]               │  │ [Выбрать]               │      │
│  └─────────────────────────┘  └─────────────────────────┘      │
│                                                                 │
│  ┌─────────────────────────┐  ┌─────────────────────────┐      │
│  │ 🔗 Кросс-промо          │  │ 📦 Пакет услуг         │      │
│  │                         │  │                         │      │
│  │ Купон в другой бизнес   │  │ Комбо от нескольких     │      │
│  │ за покупку у вас        │  │ партнеров               │      │
│  │                         │  │                         │      │
│  │ Пример: Купили еду →    │  │ Пример: Стоматология+  │      │
│  │         купон в салон   │  │         Салон+Оптика    │      │
│  │                         │  │                         │      │
│  │ [Выбрать]               │  │ [Выбрать]               │      │
│  └─────────────────────────┘  └─────────────────────────┘      │
│                                                                 │
│  ┌─────────────────────────┐                                    │
│  │ 🎁 Подарок при покупке  │                                    │
│  │                         │                                    │
│  │ Бесплатный товар/услуга │                                    │
│  │ при покупке от X₽       │                                    │
│  │                         │                                    │
│  │ Пример: Кофе в подарок  │                                    │
│  │         при заказе 5000₽│                                    │
│  │                         │                                    │
│  │ [Выбрать]               │                                    │
│  └─────────────────────────┘                                    │
│                                                                 │
│                                       [Отмена]    [Далее →]    │
└────────────────────────────────────────────────────────────────┘
```

---

**ШАГ 2: Детали предложения (пример для "Простая скидка")**

```
┌────────────────────────────────────────────────────────────────┐
│  Создание предложения: Простая скидка            Шаг 2 из 5    │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Основная информация                                           │
│  ─────────────────────────────────────────────────────────     │
│                                                                 │
│  Название предложения *                                        │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Скидка 20% на первый маникюр                             │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  Описание (видно клиентам)                                     │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Для новых клиентов салона. Распространяется на все виды  │  │
│  │ маникюра: классический, аппаратный, spa-маникюр.         │  │
│  └──────────────────────────────────────────────────────────┘  │
│  Осталось: 150 символов                                        │
│                                                                 │
│  Размер скидки *                                               │
│  ○ Процент     ● Фиксированная сумма                           │
│                                                                 │
│  ┌──────┐                                                       │
│  │ 20   │ %                                                     │
│  └──────┘                                                       │
│                                                                 │
│  На какие услуги распространяется? *                           │
│  ☑ Все услуги салона                                           │
│  ☐ Только определенные услуги                                  │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 💡 Совет: Укажите конкретные услуги, если хотите          │   │
│  │    стимулировать продажу определенных позиций.            │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│                              [← Назад]  [Далее →]              │
└────────────────────────────────────────────────────────────────┘
```

---

**ШАГ 3: Условия применения**

```
┌────────────────────────────────────────────────────────────────┐
│  Создание предложения: Простая скидка            Шаг 3 из 5    │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Кто может использовать это предложение?                       │
│  ─────────────────────────────────────────────────────────     │
│                                                                 │
│  Тип клиента *                                                 │
│  ● Только новые клиенты салона                                 │
│  ○ Только новые клиенты экосистемы "Свой Круг"                 │
│  ○ Все клиенты                                                 │
│  ○ Только постоянные клиенты (5+ визитов)                      │
│                                                                 │
│  Статус в клубе                                                │
│  ☐ Только Insider                                              │
│  ☑ VIP и выше                                                  │
│  ☐ Только Elite                                                │
│                                                                 │
│  Минимальная сумма покупки                                     │
│  ┌──────┐                                                       │
│  │ 0    │ ₽  (0 = без ограничений)                             │
│  └──────┘                                                       │
│                                                                 │
│  Дополнительные условия (опционально)                          │
│  ☐ Только в определенные дни недели                            │
│  ☐ Только в определенные часы (happy hours)                    │
│  ☐ Только в день рождения клиента                              │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 💡 Совет: Ограничение по статусу мотивирует клиентов      │   │
│  │    повышать уровень в экосистеме.                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│                              [← Назад]  [Далее →]              │
└────────────────────────────────────────────────────────────────┘
```

---

**ШАГ 4: Ограничения и бюджет**

```
┌────────────────────────────────────────────────────────────────┐
│  Создание предложения: Простая скидка            Шаг 4 из 5    │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Период действия *                                             │
│  ─────────────────────────────────────────────────────────     │
│                                                                 │
│  Начало:  [01.12.2025 ▼]  в [00:00 ▼]                         │
│  Конец:   [31.12.2025 ▼]  в [23:59 ▼]                         │
│                                                                 │
│  ⏱ Действует: 30 дней                                          │
│                                                                 │
│                                                                 │
│  Лимиты использования                                          │
│  ─────────────────────────────────────────────────────────     │
│                                                                 │
│  Общее количество использований                                │
│  ┌──────┐                                                       │
│  │ 100  │  (0 = безлимит)                                      │
│  └──────┘                                                       │
│                                                                 │
│  Использований на одного клиента                               │
│  ┌──────┐                                                       │
│  │ 1    │  (рекомендуется 1 для новых клиентов)                │
│  └──────┘                                                       │
│                                                                 │
│                                                                 │
│  Бюджет и прогноз                                              │
│  ─────────────────────────────────────────────────────────     │
│                                                                 │
│  Средний чек в салоне:     3,000₽                              │
│  Скидка:                   20% (600₽)                          │
│  Максимум использований:   100                                 │
│                                                                 │
│  📊 Прогноз расходов: 60,000₽                                  │
│  📊 Прогноз выручки:  240,000₽ (при 100% конверсии)            │
│  📊 ROI:              4x                                        │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ ⚠️ Внимание: Это максимальный расход. Фактический может   │   │
│  │   быть ниже в зависимости от конверсии.                   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│                              [← Назад]  [Далее →]              │
└────────────────────────────────────────────────────────────────┘
```

---

**ШАГ 5: Просмотр и публикация**

```
┌────────────────────────────────────────────────────────────────┐
│  Создание предложения: Простая скидка            Шаг 5 из 5    │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Проверьте детали перед публикацией                            │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Скидка 20% на первый маникюр                             │  │
│  │                                                           │  │
│  │ Тип: Простая скидка                                      │  │
│  │ Скидка: 20%                                               │  │
│  │ Для: Новых клиентов салона                               │  │
│  │ Статус: VIP и выше                                       │  │
│  │ Период: 01.12.2025 - 31.12.2025                          │  │
│  │ Лимит: 100 использований, 1 на клиента                   │  │
│  │                                                           │  │
│  │ Прогноз расходов: 60,000₽                                │  │
│  │ Прогноз выручки: 240,000₽                                │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  Как будет выглядеть в приложении клиента:                     │
│                                                                 │
│  ┌─────────────────────────── iPhone ──────────────────────┐   │
│  │  ┌────────────────────────────────────────────────────┐ │   │
│  │  │ 🎯 Скидка 20% на первый маникюр                     │ │   │
│  │  │ Салон Миндаль                                       │ │   │
│  │  │                                                     │ │   │
│  │  │ Для новых клиентов салона. Распространяется на все │ │   │
│  │  │ виды маникюра.                                      │ │   │
│  │  │                                                     │ │   │
│  │  │ ⏰ Действует до 31.12.2025                          │ │   │
│  │  │ 👥 Осталось: 100 мест                               │ │   │
│  │  │                                                     │ │   │
│  │  │        [Активировать купон]                         │ │   │
│  │  └────────────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                 │
│  Опции публикации:                                             │
│  ● Опубликовать сейчас                                         │
│  ○ Сохранить как черновик                                      │
│  ○ Запланировать публикацию: [дата ▼]                          │
│                                                                 │
│  ☑ Уведомить клиентов push-уведомлением                        │
│  ☑ Показывать на главной странице приложения                   │
│                                                                 │
│                     [← Назад]  [Опубликовать]                  │
└────────────────────────────────────────────────────────────────┘
```

---

### Мастер создания КРОСС-ПРОМО (особенности)

**ШАГ 2: Выбор партнера**

```
┌────────────────────────────────────────────────────────────────┐
│  Создание кросс-промо предложения                Шаг 2 из 6    │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Выберите партнера для кросс-промо                             │
│  ─────────────────────────────────────────────────────────     │
│                                                                 │
│  Направление:                                                  │
│  Покупка у вас (Миндаль) → Купон в другой бизнес              │
│                                                                 │
│  Рекомендуемые партнеры (на основе win-win аналитики):         │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ ⭐ Лисичкино (гастромаркет)                               │  │
│  │                                                           │  │
│  │ 📊 Win-Win индекс: 8.5/10                                 │  │
│  │ 🔄 Взаимных клиентов: 45                                  │  │
│  │ 💰 Средний LTV таких клиентов: 25,000₽                    │  │
│  │                                                           │  │
│  │ Почему хорошее сочетание:                                │  │
│  │ • Ваши клиенты часто посещают Лисичкино после салона     │  │
│  │ • Высокая конверсия: 35% ваших клиентов идут туда        │  │
│  │                                                           │  │
│  │ [Выбрать Лисичкино]                                       │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Skinerica (косметология)                                  │  │
│  │                                                           │  │
│  │ 📊 Win-Win индекс: 7.2/10                                 │  │
│  │ 🔄 Взаимных клиентов: 38                                  │  │
│  │                                                           │  │
│  │ [Выбрать Skinerica]                                       │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  Или выберите из всех партнеров:                               │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ [Показать всех партнеров ▼]                               │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│                              [← Назад]  [Далее →]              │
└────────────────────────────────────────────────────────────────┘
```

---

**ШАГ 3: Параметры кросс-промо**

```
┌────────────────────────────────────────────────────────────────┐
│  Создание кросс-промо: Миндаль → Лисичкино      Шаг 3 из 6    │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Условия получения купона                                      │
│  ─────────────────────────────────────────────────────────     │
│                                                                 │
│  Клиент получит купон в Лисичкино, если:                       │
│                                                                 │
│  Минимальная сумма покупки в Миндаль:                          │
│  ┌──────┐                                                       │
│  │ 3000 │ ₽                                                     │
│  └──────┘                                                       │
│                                                                 │
│  Тип услуги (опционально):                                     │
│  ☑ Любая услуга                                                │
│  ☐ Только маникюр                                              │
│  ☐ Только стрижка                                              │
│                                                                 │
│                                                                 │
│  Параметры купона                                              │
│  ─────────────────────────────────────────────────────────     │
│                                                                 │
│  Номинал купона:                                               │
│  ┌──────┐                                                       │
│  │ 500  │ ₽  скидка в Лисичкино                                │
│  └──────┘                                                       │
│                                                                 │
│  Срок действия купона:                                         │
│  ┌──────┐                                                       │
│  │ 10   │ дней с момента получения                             │
│  └──────┘                                                       │
│                                                                 │
│  Минимальная сумма для использования купона в Лисичкино:       │
│  ┌──────┐                                                       │
│  │ 2000 │ ₽                                                     │
│  └──────┘                                                       │
│                                                                 │
│                                                                 │
│  Бюджет акции                                                  │
│  ─────────────────────────────────────────────────────────     │
│                                                                 │
│  Кто финансирует купоны?                                       │
│  ● Я (Миндаль) - 100%                                          │
│  ○ Партнер (Лисичкино) - 100%                                  │
│  ○ Разделить 50/50                                             │
│  ○ Платформа "Свой Круг"                                       │
│                                                                 │
│  Общий бюджет:                                                 │
│  ┌──────┐                                                       │
│  │ 50000│ ₽                                                     │
│  └──────┘                                                       │
│                                                                 │
│  Максимум купонов: 100 (50000₽ / 500₽)                        │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 💡 Логика: Вы привлекаете клиентов в Лисичкино, они       │   │
│  │    возвращаются к вам с большей вероятностью.             │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│                              [← Назад]  [Далее →]              │
└────────────────────────────────────────────────────────────────┘
```

---

**ШАГ 4: Согласование с партнером**

```
┌────────────────────────────────────────────────────────────────┐
│  Создание кросс-промо: Миндаль → Лисичкино      Шаг 4 из 6    │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Согласование условий с партнером                              │
│  ─────────────────────────────────────────────────────────     │
│                                                                 │
│  Ваше предложение будет отправлено Лисичкино на одобрение.    │
│                                                                 │
│  Сообщение партнеру:                                           │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Здравствуйте!                                             │  │
│  │                                                           │  │
│  │ Предлагаю создать кросс-промо акцию:                      │  │
│  │ Мои клиенты, потратившие от 3000₽, получат купон 500₽    │  │
│  │ на покупку в вашем гастромаркете.                         │  │
│  │                                                           │  │
│  │ Это поможет:                                              │  │
│  │ • Привести вам новых клиентов из моей базы               │  │
│  │ • Увеличить кросс-продажи внутри экосистемы              │  │
│  │                                                           │  │
│  │ Готова обсудить детали!                                   │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  Что видит партнер в своей панели:                             │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 📩 Новое предложение о сотрудничестве                     │  │
│  │                                                           │  │
│  │ От: Салон Миндаль                                         │  │
│  │ Тип: Кросс-промо (клиенты Миндаль → купон в Лисичкино)   │  │
│  │                                                           │  │
│  │ Условия:                                                  │  │
│  │ • Купон 500₽ при покупке от 2000₽                        │  │
│  │ • Срок действия: 10 дней                                 │  │
│  │ • Финансирование: Миндаль (100%)                          │  │
│  │                                                           │  │
│  │ Прогноз для вас:                                          │  │
│  │ • +50-100 новых клиентов                                 │  │
│  │ • Возможная выручка: 150,000-300,000₽                    │  │
│  │                                                           │  │
│  │ [Одобрить] [Предложить изменения] [Отклонить]            │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│                                                                 │
│  Уведомления:                                                  │
│  ☑ Отправить партнеру email                                    │
│  ☑ Отправить уведомление в Telegram                            │
│                                                                 │
│                     [← Назад]  [Отправить запрос]              │
└────────────────────────────────────────────────────────────────┘
```

---

## МЕХАНИКА ЦЕПОЧЕК (КРОСС-ПРОМО)

### Типы цепочек

#### 1. Простая цепочка (A → B)

**Схема:**
```
Клиент       Клиент           Клиент           Клиент
покупает  →  получает     →   использует   →   получает
в A          купон на B       купон в B        бонусы
```

**Пример:**
```
Купил в Лисичкино   →  Получил купон      →  Купил в Миндаль  →  +200₽ бонусов
от 3000₽               500₽ на Миндаль       с купоном
```

**Выгоды:**
- Лисичкино: привлекает клиентов в партнерский бизнес → повышает ценность экосистемы
- Миндаль: получает новых клиентов бесплатно
- Клиент: экономит 500₽

---

#### 2. Последовательная цепочка (A → B → C)

**Схема:**
```
Шаг 1: Покупка в A  →  Купон на B
Шаг 2: Покупка в B  →  Купон на C
Шаг 3: Покупка в C  →  Повышенные бонусы в A
```

**Пример:**
```
Цепочка "Beauty Journey":

1. Купил в Лисичкино от 5000₽
   ↓
   Получил купон 1000₽ на Миндаль (маникюр + стрижка)

2. Использовал купон в Миндаль
   ↓
   Получил купон 500₽ на Skinerica (косметология)

3. Использовал купон в Skinerica
   ↓
   Получил 3x бонусы при следующей покупке в Лисичкино
```

**Выгоды:**
- Все 3 бизнеса получают новых клиентов
- Клиент проходит полный цикл услуг со скидкой
- Высокая вовлеченность в экосистему

---

#### 3. Циклическая цепочка (A ⇄ B)

**Схема:**
```
Покупка в A  →  Купон на B
Покупка в B  →  Купон на A
(цикл повторяется)
```

**Пример:**
```
"Ужин + Красота" (Лисичкино ⇄ Миндаль):

Каждый месяц:
- Купил в Лисичкино → купон на Миндаль
- Купил в Миндаль → купон на Лисичкино

Результат: Клиент регулярно чередует посещения
```

**Выгоды:**
- Формирование привычки
- Предсказуемый поток клиентов
- Повышение retention rate

---

#### 4. Веерная цепочка (A → [B, C, D])

**Схема:**
```
Покупка в A  →  Выбор купона:
                - Купон на B (500₽)
                - Купон на C (300₽)
                - Купон на D (700₽)
```

**Пример:**
```
"VIP-Пакет" от Миллениум:

Прошел чекап в клинике → Выбери один из купонов:
- Гастромаркет Лисичкино (500₽)
- Салон Миндаль (300₽)
- Стоматология Стим (700₽)
```

**Выгоды:**
- Клиент выбирает интересное ему направление
- Повышение персонализации
- Все партнеры получают трафик

---

### Конструктор цепочек для администратора

**UI: Визуальный редактор цепочек**

```
┌────────────────────────────────────────────────────────────────┐
│  Конструктор цепочек                     [Сохранить] [Отмена]  │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Название цепочки:                                             │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Beauty Journey                                            │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  Визуальный редактор:                                          │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                                                           │  │
│  │  ┌─────────────┐                                          │  │
│  │  │ Лисичкино   │                                          │  │
│  │  │ Покупка     │                                          │  │
│  │  │ от 5000₽    │                                          │  │
│  │  └──────┬──────┘                                          │  │
│  │         │                                                  │  │
│  │         │ Купон 1000₽                                     │  │
│  │         │ Срок: 10 дней                                   │  │
│  │         ↓                                                  │  │
│  │  ┌─────────────┐                                          │  │
│  │  │ Миндаль     │                                          │  │
│  │  │ Использовал │                                          │  │
│  │  │ купон       │                                          │  │
│  │  └──────┬──────┘                                          │  │
│  │         │                                                  │  │
│  │         │ Купон 500₽                                      │  │
│  │         │ Срок: 10 дней                                   │  │
│  │         ↓                                                  │  │
│  │  ┌─────────────┐                                          │  │
│  │  │ Skinerica   │                                          │  │
│  │  │ Использовал │                                          │  │
│  │  │ купон       │                                          │  │
│  │  └──────┬──────┘                                          │  │
│  │         │                                                  │  │
│  │         │ 3x бонусы                                       │  │
│  │         │ в Лисичкино                                     │  │
│  │         ↓                                                  │  │
│  │  ┌─────────────┐                                          │  │
│  │  │ 🎁 Награда  │                                          │  │
│  │  └─────────────┘                                          │  │
│  │                                                           │  │
│  │  [+ Добавить шаг]                                         │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  Боковая панель (настройка выбранного шага):                   │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Шаг 1: Лисичкино                                          │  │
│  │                                                           │  │
│  │ Минимальная покупка: [5000] ₽                            │  │
│  │                                                           │  │
│  │ Выдаваемый купон:                                         │  │
│  │ Бизнес: [Миндаль ▼]                                       │  │
│  │ Номинал: [1000] ₽                                         │  │
│  │ Срок действия: [10] дней                                 │  │
│  │ Мин. сумма для использования: [1500] ₽                   │  │
│  │                                                           │  │
│  │ Финансирование:                                           │  │
│  │ ○ Лисичкино (100%)                                        │  │
│  │ ○ Миндаль (100%)                                          │  │
│  │ ● Платформа (100%)                                        │  │
│  │                                                           │  │
│  │ [Удалить шаг]                                             │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  Прогноз эффективности:                                        │
│  📊 Ожидаемая конверсия: 15-25%                                │
│  💰 Прогноз бюджета: 150,000₽                                  │
│  👥 Охват: 500 клиентов                                        │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

---

### Правила и ограничения цепочек

```yaml
Ограничения платформы:

Максимальная длина цепочки:
  - 5 шагов (A → B → C → D → E)
  - Больше 5 - слишком сложно для клиента

Срок действия цепочки:
  - Общий срок: не более 90 дней
  - Каждый купон: 7-14 дней (чтобы не забыли)

Бюджет на цепочку:
  - Максимум 500,000₽ на одну цепочку
  - Распределяется между бизнесами или оплачивается платформой

Участие бизнесов:
  - Минимум 2, максимум 5 бизнесов в цепочке
  - Каждый бизнес должен дать согласие
  - Можно отказаться в любой момент (с уведомлением за 7 дней)

Конфликт интересов:
  - Нельзя включать конкурентов в одну цепочку
  - Один бизнес не может появляться дважды в цепочке

Модерация:
  - Цепочки длиной 3+ шага требуют одобрения администратора
  - Проверка на адекватность условий
  - Проверка финансовой устойчивости
```

---

## ПАНЕЛЬ АДМИНИСТРАТОРА

### Дашборд управления предложениями

```
┌────────────────────────────────────────────────────────────────┐
│  Управление предложениями (Админ)                              │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Статистика за месяц:                                          │
│  ─────────────────────────────────────────────────────────     │
│                                                                 │
│  Всего предложений: 47        Активных: 32     Черновиков: 8   │
│  На модерации: 7              Истекших: 15                     │
│                                                                 │
│  Конверсия: 22.5%             Использовано купонов: 1,234      │
│  Выручка от предложений: 1,850,000₽                            │
│                                                                 │
│                                                                 │
│  Фильтры:                                                      │
│  [Все бизнесы ▼] [Все типы ▼] [Все статусы ▼] [🔍 Поиск...]   │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ ⏸ На модерации                                            │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 🔗 Кросс-промо: Миндаль → Лисичкино                       │  │
│  │ Статус: ⏸ Ожидает одобрения партнера                      │  │
│  │                                                           │  │
│  │ От: Салон Миндаль                                         │  │
│  │ Партнер: Лисичкино                                        │  │
│  │ Купон: 500₽ при покупке от 3000₽                         │  │
│  │ Бюджет: 50,000₽                                           │  │
│  │                                                           │  │
│  │ Создано: 15.11.2025                                       │  │
│  │ Отправлено партнеру: 15.11.2025 14:30                    │  │
│  │                                                           │  │
│  │ [Подробнее] [Одобрить напрямую] [Отклонить]              │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 📦 Пакет: Smile & Style                                   │  │
│  │ Статус: ⏸ На модерации (требует проверки)                 │  │
│  │                                                           │  │
│  │ Бизнесы: Стим + Миндаль + Оптика                          │  │
│  │ Цена: 8,800₽ (вместо 11,000₽)                            │  │
│  │ Создано: 14.11.2025                                       │  │
│  │                                                           │  │
│  │ ⚠️ Требуется проверка:                                     │  │
│  │    • Скидка 20% - не слишком ли высокая?                 │  │
│  │    • Все 3 бизнеса подтвердили участие                   │  │
│  │                                                           │  │
│  │ [Подробнее] [Одобрить] [Запросить изменения] [Отклонить] │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ ✅ Активные предложения                                   │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 💰 Скидка 20% на маникюр (Миндаль)                        │  │
│  │ Статус: ● Активна                      До: 31.12.2025    │  │
│  │                                                           │  │
│  │ Использовано: 23 / 100                                    │  │
│  │ Конверсия: 45%                                            │  │
│  │ Выручка: +34,500₽                                         │  │
│  │                                                           │  │
│  │ 📈 Растущая популярность (+12% за неделю)                │  │
│  │                                                           │  │
│  │ [Подробная аналитика] [Продлить] [⏸ Приостановить]       │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

---

### Система одобрения предложений

**Workflow модерации:**

```
┌─────────────────────────────────────────────────────────────┐
│                WORKFLOW МОДЕРАЦИИ ПРЕДЛОЖЕНИЙ               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Шаг 1: Создание предложения собственником                 │
│  ───────────────────────────────────────────────────────    │
│  ┌────────────────┐                                         │
│  │ Собственник    │                                         │
│  │ создает        │                                         │
│  │ предложение    │                                         │
│  └───────┬────────┘                                         │
│          │                                                  │
│          ↓                                                  │
│  ┌────────────────────────────┐                             │
│  │ Автоматическая проверка    │                             │
│  │ • Корректность параметров  │                             │
│  │ • Нет запрещенных слов     │                             │
│  │ • Бюджет в пределах нормы  │                             │
│  └───────┬────────────────────┘                             │
│          │                                                  │
│          ├─→ [ОК] → Если простая скидка → Публикуется      │
│          │                                                  │
│          └─→ [Проверка нужна] → Если кросс-промо/пакет     │
│                      ↓                                      │
│  Шаг 2: Согласование с партнерами (если нужно)             │
│  ───────────────────────────────────────────────────────    │
│  ┌────────────────────────────┐                             │
│  │ Уведомление партнеру       │                             │
│  │ через Email + Push + Telegram │                          │
│  └───────┬────────────────────┘                             │
│          │                                                  │
│          │ Партнер видит в своей панели                     │
│          ↓                                                  │
│  ┌────────────────────────────┐                             │
│  │ Партнер принимает решение: │                             │
│  │ • Одобрить                 │                             │
│  │ • Предложить изменения     │                             │
│  │ • Отклонить                │                             │
│  └───────┬────────────────────┘                             │
│          │                                                  │
│          ├─→ [Одобрено] → Переход к Шагу 3                 │
│          │                                                  │
│          ├─→ [Изменения] → Возврат собственнику на правку  │
│          │                                                  │
│          └─→ [Отклонено] → Предложение архивируется         │
│                                                             │
│  Шаг 3: Модерация администратором (если сложное)           │
│  ───────────────────────────────────────────────────────    │
│  ┌────────────────────────────┐                             │
│  │ Администратор проверяет:   │                             │
│  │ • Адекватность условий     │                             │
│  │ • Соответствие политике    │                             │
│  │ • Финансовая устойчивость  │                             │
│  └───────┬────────────────────┘                             │
│          │                                                  │
│          ├─→ [Одобрено] → Публикация                       │
│          │                                                  │
│          ├─→ [Запрос изменений] → Возврат собственнику     │
│          │                                                  │
│          └─→ [Отклонено] → Объяснение причины               │
│                                                             │
│  Шаг 4: Публикация                                          │
│  ───────────────────────────────────────────────────────    │
│  ┌────────────────────────────┐                             │
│  │ • Предложение в приложении │                             │
│  │ • Push-уведомления         │                             │
│  │ • Email-рассылка           │                             │
│  │ • Пост в Telegram          │                             │
│  └────────────────────────────┘                             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

### Создание системных цепочек администратором

**Особенность:** Администратор может создавать цепочки от имени платформы с финансированием из общего бюджета.

**Пример UI:**

```
┌────────────────────────────────────────────────────────────────┐
│  Создание системной цепочки (Админ)              [Сохранить]   │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Название: "Новогодняя цепочка 2026"                           │
│                                                                 │
│  Описание:                                                     │
│  Особая цепочка для новых участниц в декабре. Мотивируем      │
│  попробовать разные категории экосистемы.                      │
│                                                                 │
│  Шаги цепочки:                                                 │
│  ───────────────────────────────────────────────────────────   │
│                                                                 │
│  1. Лисичкино (гастромаркет)                                   │
│     Триггер: Первая покупка от 2000₽                           │
│     Награда: Купон 700₽ на Миндаль                             │
│     Финансирование: Платформа (100%)                           │
│                                                                 │
│  2. Миндаль (салон)                                            │
│     Триггер: Использовал купон                                 │
│     Награда: Купон 500₽ на Стим                                │
│     Финансирование: Платформа (100%)                           │
│                                                                 │
│  3. Стим (стоматология)                                        │
│     Триггер: Использовал купон                                 │
│     Награда: Статус VIP (временный, на 30 дней)               │
│     Финансирование: Платформа                                  │
│                                                                 │
│  Параметры:                                                    │
│  ───────────────────────────────────────────────────────────   │
│                                                                 │
│  Период действия: 01.12.2025 - 31.01.2026                     │
│  Целевая аудитория: Новые участницы (регистрация < 30 дней)   │
│  Бюджет платформы: 300,000₽                                    │
│  Максимум участников: 200                                      │
│                                                                 │
│  Прогноз:                                                      │
│  ───────────────────────────────────────────────────────────   │
│                                                                 │
│  Ожидаемая конверсия:                                          │
│  • Шаг 1→2: 60% (120 человек)                                 │
│  • Шаг 2→3: 50% (60 человек)                                  │
│  • Завершат цепочку: 30% (60 человек)                          │
│                                                                 │
│  Фактические расходы: ~180,000₽                                │
│  Прогноз LTV новых клиентов: 600,000₽                          │
│  ROI: 3.3x                                                     │
│                                                                 │
│  [Опубликовать] [Сохранить как черновик]                       │
└────────────────────────────────────────────────────────────────┘
```

---

## БАЗА ДАННЫХ И API

### Схема БД для предложений

```sql
-- ТАБЛИЦА ПРЕДЛОЖЕНИЙ
CREATE TABLE offers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  offer_type VARCHAR(50) NOT NULL, -- simple_discount/bonus_cashback/cross_promo/package/gift
  creator_id UUID REFERENCES users(id), -- кто создал
  creator_type VARCHAR(20), -- business_owner/admin
  
  title VARCHAR(255) NOT NULL,
  description TEXT,
  
  -- JSON с параметрами в зависимости от типа
  parameters JSONB NOT NULL,
  
  -- Условия применения
  conditions JSONB,
  
  -- Ограничения
  limitations JSONB,
  
  -- Бюджет
  budget_total DECIMAL(12,2),
  budget_used DECIMAL(12,2) DEFAULT 0,
  
  -- Статус
  status VARCHAR(20) DEFAULT 'draft', -- draft/pending_approval/active/paused/expired/rejected
  moderation_notes TEXT,
  
  -- Даты
  valid_from TIMESTAMP,
  valid_until TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  
  -- Статистика
  views_count INTEGER DEFAULT 0,
  uses_count INTEGER DEFAULT 0,
  max_uses INTEGER,
  
  -- Одобрения
  requires_partner_approval BOOLEAN DEFAULT FALSE,
  partner_approved_at TIMESTAMP,
  admin_approved_at TIMESTAMP
);

-- Индексы
CREATE INDEX idx_offers_status ON offers(status);
CREATE INDEX idx_offers_creator ON offers(creator_id);
CREATE INDEX idx_offers_dates ON offers(valid_from, valid_until);
CREATE INDEX idx_offers_type ON offers(offer_type);

-- ТАБЛИЦА УЧАСТНИКОВ ПРЕДЛОЖЕНИЯ (для кросс-промо и пакетов)
CREATE TABLE offer_participants (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  offer_id UUID REFERENCES offers(id) ON DELETE CASCADE,
  business_id UUID REFERENCES businesses(id),
  role VARCHAR(20), -- source/target/package_member
  share_percentage DECIMAL(5,2), -- для пакетов
  approval_status VARCHAR(20) DEFAULT 'pending', -- pending/approved/rejected
  approved_at TIMESTAMP,
  approved_by UUID REFERENCES users(id)
);

-- ТАБЛИЦА КУПОНОВ
CREATE TABLE coupons (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  offer_id UUID REFERENCES offers(id),
  user_id UUID REFERENCES users(id),
  
  code VARCHAR(50) UNIQUE NOT NULL, -- ABC123XYZ
  
  -- Параметры купона
  coupon_type VARCHAR(20), -- fixed_discount/percentage_discount/bonus
  value DECIMAL(10,2),
  
  -- Условия использования
  min_purchase DECIMAL(10,2),
  target_business_id UUID REFERENCES businesses(id),
  
  -- Статус
  status VARCHAR(20) DEFAULT 'active', -- active/used/expired
  
  -- Даты
  issued_at TIMESTAMP DEFAULT NOW(),
  expires_at TIMESTAMP,
  used_at TIMESTAMP,
  
  -- Где использован
  transaction_id UUID REFERENCES transactions(id)
);

-- Индексы
CREATE INDEX idx_coupons_user ON coupons(user_id);
CREATE INDEX idx_coupons_code ON coupons(code);
CREATE INDEX idx_coupons_status ON coupons(status, expires_at);

-- ТАБЛИЦА ЦЕПОЧЕК
CREATE TABLE chains (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  description TEXT,
  
  -- JSON-массив шагов цепочки
  steps JSONB NOT NULL,
  
  -- Кто создал
  creator_id UUID REFERENCES users(id),
  creator_type VARCHAR(20), -- business_owner/admin
  
  -- Бюджет
  total_budget DECIMAL(12,2),
  budget_used DECIMAL(12,2) DEFAULT 0,
  
  -- Статус
  status VARCHAR(20) DEFAULT 'draft',
  
  -- Даты
  valid_from TIMESTAMP,
  valid_until TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
);

-- ТАБЛИЦА ПРОГРЕССА КЛИЕНТОВ ПО ЦЕПОЧКАМ
CREATE TABLE chain_progress (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  chain_id UUID REFERENCES chains(id),
  user_id UUID REFERENCES users(id),
  
  current_step INTEGER DEFAULT 0,
  completed_steps JSONB DEFAULT '[]', -- массив завершенных шагов
  
  started_at TIMESTAMP DEFAULT NOW(),
  last_step_at TIMESTAMP,
  completed_at TIMESTAMP,
  
  UNIQUE(chain_id, user_id)
);

-- ТАБЛИЦА ИСПОЛЬЗОВАНИЯ ПРЕДЛОЖЕНИЙ (аналитика)
CREATE TABLE offer_usage (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  offer_id UUID REFERENCES offers(id),
  user_id UUID REFERENCES users(id),
  
  -- Детали использования
  transaction_id UUID REFERENCES transactions(id),
  discount_amount DECIMAL(10,2),
  bonus_amount DECIMAL(10,2),
  
  used_at TIMESTAMP DEFAULT NOW()
);

-- Индексы
CREATE INDEX idx_offer_usage_offer ON offer_usage(offer_id, used_at DESC);
CREATE INDEX idx_offer_usage_user ON offer_usage(user_id);
```

---

### API Endpoints

#### Для собственников бизнеса

```python
# СОЗДАНИЕ ПРЕДЛОЖЕНИЯ
POST /api/v1/offers
Headers: Authorization: Bearer {token}
Request:
{
  "offer_type": "simple_discount",
  "title": "Скидка 20% на первый маникюр",
  "description": "Для новых клиентов салона",
  "parameters": {
    "discount": {
      "type": "percentage",
      "value": 20
    }
  },
  "conditions": {
    "new_customers_only": true,
    "min_purchase": 0,
    "status_required": "insider"
  },
  "limitations": {
    "valid_from": "2025-12-01T00:00:00",
    "valid_until": "2025-12-31T23:59:59",
    "max_uses": 100,
    "uses_per_customer": 1
  },
  "budget_total": 60000,
  "stackable": false
}
Response:
{
  "offer_id": "uuid",
  "status": "active", // или "pending_approval" если нужна модерация
  "message": "Предложение создано и опубликовано"
}

# ПОЛУЧЕНИЕ СПИСКА СВОИХ ПРЕДЛОЖЕНИЙ
GET /api/v1/offers/my?status=active&limit=20
Response:
{
  "offers": [
    {
      "id": "uuid",
      "title": "Скидка 20% на первый маникюр",
      "status": "active",
      "uses_count": 23,
      "max_uses": 100,
      "conversion_rate": 0.45,
      "revenue_generated": 34500,
      "valid_until": "2025-12-31T23:59:59"
    },
    ...
  ],
  "total": 5
}

# АНАЛИТИКА ПРЕДЛОЖЕНИЯ
GET /api/v1/offers/{offer_id}/analytics
Response:
{
  "offer_id": "uuid",
  "title": "Скидка 20% на первый маникюр",
  "period": {
    "from": "2025-12-01",
    "to": "2025-12-15"
  },
  "stats": {
    "views": 51,
    "uses": 23,
    "conversion_rate": 0.45,
    "revenue_generated": 34500,
    "discount_given": 13800,
    "roi": 2.5
  },
  "usage_by_day": [
    {
      "date": "2025-12-01",
      "uses": 3,
      "revenue": 4500
    },
    ...
  ],
  "top_users": [
    {
      "user_id": "uuid",
      "user_name": "Анна С.",
      "used_at": "2025-12-05T14:30:00",
      "purchase_amount": 1500
    },
    ...
  ]
}

# РЕДАКТИРОВАНИЕ ПРЕДЛОЖЕНИЯ
PATCH /api/v1/offers/{offer_id}
Request:
{
  "valid_until": "2026-01-31T23:59:59", // продлить
  "max_uses": 150 // увеличить лимит
}

# ПРИОСТАНОВКА/АКТИВАЦИЯ
POST /api/v1/offers/{offer_id}/pause
POST /api/v1/offers/{offer_id}/activate

# СОЗДАНИЕ КРОСС-ПРОМО (требует согласия партнера)
POST /api/v1/offers/cross-promo
Request:
{
  "title": "Купон в Лисичкино за покупку в Миндаль",
  "source_business_id": "uuid-mindal", // мой бизнес
  "target_business_id": "uuid-lisichkino", // партнер
  "trigger": {
    "min_purchase": 3000
  },
  "coupon": {
    "type": "fixed_discount",
    "value": 500,
    "expires_in_days": 10,
    "min_purchase_to_use": 2000
  },
  "budget": {
    "total_budget": 50000,
    "financed_by": "source" // source/target/platform/split
  },
  "message_to_partner": "Привет! Предлагаю акцию..."
}
Response:
{
  "offer_id": "uuid",
  "status": "pending_partner_approval",
  "partner_notified": true,
  "message": "Запрос отправлен партнеру. Ожидайте ответа."
}
```

---

#### Для администратора платформы

```python
# ОДОБРЕНИЕ ПРЕДЛОЖЕНИЯ
POST /api/v1/admin/offers/{offer_id}/approve
Request:
{
  "notes": "Одобрено. Хорошая акция."
}

# ОТКЛОНЕНИЕ
POST /api/v1/admin/offers/{offer_id}/reject
Request:
{
  "reason": "Скидка слишком высокая. Рекомендуем снизить до 15%.",
  "suggestions": "Уменьшите скидку или увеличьте минимальную сумму покупки."
}

# ЗАПРОС НА ИЗМЕНЕНИЯ
POST /api/v1/admin/offers/{offer_id}/request-changes
Request:
{
  "requested_changes": [
    "Снизить скидку до 15%",
    "Увеличить минимальную сумму до 2000₽"
  ]
}

# СОЗДАНИЕ СИСТЕМНОЙ ЦЕПОЧКИ
POST /api/v1/admin/chains
Request:
{
  "name": "Новогодняя цепочка 2026",
  "description": "...",
  "steps": [
    {
      "step_number": 1,
      "business_id": "uuid-lisichkino",
      "trigger": {
        "type": "purchase",
        "min_amount": 2000
      },
      "reward": {
        "type": "coupon",
        "target_business_id": "uuid-mindal",
        "value": 700
      },
      "financed_by": "platform"
    },
    {
      "step_number": 2,
      "business_id": "uuid-mindal",
      "trigger": {
        "type": "coupon_used"
      },
      "reward": {
        "type": "coupon",
        "target_business_id": "uuid-stim",
        "value": 500
      },
      "financed_by": "platform"
    },
    {
      "step_number": 3,
      "business_id": "uuid-stim",
      "trigger": {
        "type": "coupon_used"
      },
      "reward": {
        "type": "status_upgrade",
        "status": "vip",
        "duration_days": 30
      }
    }
  ],
  "valid_from": "2025-12-01",
  "valid_until": "2026-01-31",
  "target_audience": {
    "new_users_only": true,
    "registered_within_days": 30
  },
  "budget": 300000,
  "max_participants": 200
}

# АНАЛИТИКА ВСЕХ ПРЕДЛОЖЕНИЙ
GET /api/v1/admin/offers/analytics/overview
Response:
{
  "total_offers": 47,
  "active": 32,
  "pending_approval": 7,
  "total_uses": 1234,
  "total_revenue_generated": 1850000,
  "total_discount_given": 420000,
  "average_conversion": 0.225,
  "roi": 4.4,
  
  "by_type": {
    "simple_discount": {
      "count": 20,
      "uses": 567,
      "revenue": 890000
    },
    "cross_promo": {
      "count": 15,
      "uses": 423,
      "revenue": 650000
    },
    ...
  },
  
  "top_performing": [
    {
      "offer_id": "uuid",
      "title": "...",
      "business": "Миндаль",
      "uses": 89,
      "roi": 6.2
    },
    ...
  ]
}
```

---

## АНАЛИТИКА ЭФФЕКТИВНОСТИ

### Метрики для собственников

```yaml
Основные показатели:

Просмотры (Views):
  Определение: Сколько раз предложение было показано клиентам
  Где: В приложении на главной, в каталоге, в push-уведомлениях

Активации (Activations):
  Определение: Сколько клиентов активировали купон/предложение
  Формула: Активации / Просмотры = Конверсия в активацию

Использования (Uses):
  Определение: Сколько раз предложение было реально использовано
  Формула: Использования / Активации = Конверсия в использование

Выручка (Revenue):
  Определение: Суммарная выручка от покупок с этим предложением
  Формула: Σ (сумма покупки с использованием предложения)

Скидка (Discount Given):
  Определение: Сколько денег было отдано в виде скидок
  Формула: Σ (размер скидки на каждую покупку)

ROI (Return on Investment):
  Определение: Окупаемость инвестиций в предложение
  Формула: (Выручка - Скидка) / Скидка
  Пример: (34500₽ - 13800₽) / 13800₽ = 1.5 (150% ROI)

Средний чек (Average Check):
  Определение: Средняя сумма покупки с использованием предложения
  Формула: Выручка / Использования

Новые клиенты (New Customers):
  Определение: Сколько новых клиентов привлекло предложение
  Важно: Для кросс-промо - сколько пришло из другого бизнеса
```

---

### Дашборд аналитики для собственника

```
┌────────────────────────────────────────────────────────────────┐
│  Аналитика предложения: "Скидка 20% на первый маникюр"        │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Период: 01.12.2025 - 15.12.2025 (15 дней из 31)              │
│                                                                 │
│  Основные показатели:                                          │
│  ┌──────────────┬──────────────┬──────────────┬──────────────┐ │
│  │ Просмотры    │ Активации    │ Использовано │ Конверсия    │ │
│  │ 51           │ 34           │ 23           │ 45%          │ │
│  │              │ (67%)        │ (68%)        │ итоговая     │ │
│  └──────────────┴──────────────┴──────────────┴──────────────┘ │
│                                                                 │
│  Финансовые показатели:                                        │
│  ┌──────────────┬──────────────┬──────────────┬──────────────┐ │
│  │ Выручка      │ Скидка дана  │ Чистая       │ ROI          │ │
│  │ 34,500₽      │ 13,800₽      │ 20,700₽      │ 1.5x (150%) │ │
│  └──────────────┴──────────────┴──────────────┴──────────────┘ │
│                                                                 │
│  Средний чек: 1,500₽ (без скидки было бы 1,875₽)              │
│                                                                 │
│                                                                 │
│  График использований по дням:                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │       📊                                                  │  │
│  │   6 │     ██                                             │  │
│  │   5 │     ██    ██                                       │  │
│  │   4 │     ██    ██                                       │  │
│  │   3 │     ██    ██    ██                                 │  │
│  │   2 │  ██ ██ ██ ██    ██ ██                             │  │
│  │   1 │  ██ ██ ██ ██ ██ ██ ██ ██ ██                       │  │
│  │   0 └─────────────────────────────────────────────────  │  │
│  │      1  2  3  4  5  6  7  8  9 10 11 12 13 14 15        │  │
│  │                        Декабрь                           │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  Прогноз до конца месяца:                                      │
│  При текущей динамике к 31.12.2025 ожидается:                 │
│  • Использований: ~47 (из 100 доступных)                      │
│  • Выручка: ~70,500₽                                           │
│  • Скидка: ~28,200₽                                            │
│  • ROI: ~1.5x                                                  │
│                                                                 │
│                                                                 │
│  Топ-5 клиентов, использовавших предложение:                   │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 1. Анна С.        05.12  14:30   Покупка: 1,500₽        │  │
│  │ 2. Мария П.       07.12  11:00   Покупка: 2,200₽        │  │
│  │ 3. Елена К.       08.12  16:45   Покупка: 1,800₽        │  │
│  │ 4. Ольга Д.       10.12  13:20   Покупка: 1,200₽        │  │
│  │ 5. Ирина Л.       12.12  15:00   Покупка: 1,600₽        │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  Рекомендации:                                                 │
│  💡 Конверсия выше средней (45% vs 20-25% обычно). Хорошо!    │
│  💡 Рассмотрите продление акции до конца января.              │
│  ⚠️ Использовано только 23 из 100. Усильте промо в соцсетях.  │
│                                                                 │
│  [Экспортировать отчет] [Продлить акцию] [Создать похожую]    │
└────────────────────────────────────────────────────────────────┘
```

---

### Win-Win аналитика цепочек (для админа)

```
┌────────────────────────────────────────────────────────────────┐
│  Win-Win аналитика кросс-промо                                 │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Период: Ноябрь 2025                                           │
│                                                                 │
│  Топ-5 успешных связок:                                        │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 1. Лисичкино → Миндаль                                    │  │
│  │    Конверсия: 35% (45 из 128 клиентов)                   │  │
│  │    Средний LTV: 25,000₽                                   │  │
│  │    Win-Win индекс: ⭐⭐⭐⭐⭐ 8.5/10                          │  │
│  │                                                           │  │
│  │    Детали:                                                │  │
│  │    • Клиенты Лисичкино охотно идут в салон               │  │
│  │    • Обратная связка (Миндаль→Лисичкино): 28%            │  │
│  │    • Рекомендация: Создать циклическую цепочку           │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 2. Миндаль → Skinerica                                    │  │
│  │    Конверсия: 30% (38 из 127)                            │  │
│  │    Средний LTV: 32,000₽                                   │  │
│  │    Win-Win индекс: ⭐⭐⭐⭐ 7.2/10                           │  │
│  │                                                           │  │
│  │    Детали:                                                │  │
│  │    • Логичная связка: красота → косметология             │  │
│  │    • Высокий чек в Skinerica (средний: 8,500₽)           │  │
│  │    • Рекомендация: Увеличить номинал купона              │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 3. Стим → Миллениум                                       │  │
│  │    Конверсия: 25% (28 из 112)                            │  │
│  │    Средний LTV: 45,000₽                                   │  │
│  │    Win-Win индекс: ⭐⭐⭐⭐ 6.8/10                           │  │
│  │                                                           │  │
│  │    Детали:                                                │  │
│  │    • Связка медицинских услуг работает                   │  │
│  │    • Клиенты ценят комплексный подход к здоровью         │  │
│  │    • Рекомендация: Создать пакет "Здоровье"              │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│                                                                 │
│  Неудачные связки (низкая конверсия):                          │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ ❌ Оптика → Лисичкино                                     │  │
│  │    Конверсия: 5% (3 из 60)                               │  │
│  │    Проблема: Нет логической связи                        │  │
│  │    Рекомендация: Прекратить эту цепочку                  │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  Матрица переходов (упрощенная):                               │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │        →│ Лисич│ Минда│ Stim │ Skine│ Милле│ Оптик│      │  │
│  │         │      │      │      │      │      │      │      │  │
│  │ Лисичк. │  -   │ 35%  │ 12%  │  8%  │ 15%  │  3%  │      │  │
│  │ Миндаль │ 28%  │  -   │ 18%  │ 30%  │ 10%  │  7%  │      │  │
│  │ Стим    │ 20%  │ 22%  │  -   │ 15%  │ 25%  │  5%  │      │  │
│  │ Skiner. │ 18%  │ 25%  │ 10%  │  -   │ 20%  │  4%  │      │  │
│  │ Миллен. │ 22%  │ 15%  │ 28%  │ 18%  │  -   │  6%  │      │  │
│  │ Оптика  │  5%  │ 12%  │ 10%  │  8%  │  7%  │  -   │      │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  Зеленый = высокая конверсия (>20%)                            │
│  Желтый = средняя (10-20%)                                     │
│  Красный = низкая (<10%)                                       │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

---

## ПРИМЕРЫ СЦЕНАРИЕВ

### Сценарий 1: Простая скидка от собственника

**Участники:** Собственница салона Миндаль

**Задача:** Привлечь новых клиентов в салон в декабре

**Шаги:**

1. **Вход в панель**
   - Переходит на business.svoy-krug.ru
   - Логин через SMS

2. **Создание предложения**
   - Нажимает [+ Создать предложение]
   - Выбирает "Простая скидка"
   - Заполняет:
     - Название: "Скидка 20% на первый маникюр"
     - Скидка: 20%
     - Для новых клиентов салона
     - VIP и выше
     - Период: 01.12.2025 - 31.12.2025
     - Лимит: 100 использований

3. **Проверка и публикация**
   - Видит предварительный просмотр
   - Видит прогноз: Расход 60,000₽, выручка 240,000₽
   - Нажимает [Опубликовать]
   - ✅ Отправляет push всем клиентам VIP+

4. **Результат**
   - Предложение сразу активно (не требует модерации)
   - Клиенты видят в приложении
   - За 2 недели: 23 использования, выручка 34,500₽

---

### Сценарий 2: Кросс-промо между партнерами

**Участники:** Собственница Миндаль + Собственница Лисичкино

**Задача:** Привести клиентов салона в гастромаркет

**Шаги:**

1. **Миндаль создает предложение**
   - Выбирает "Кросс-промо"
   - Источник: Миндаль (я)
   - Цель: Лисичкино (партнер)
   - Условие: Покупка от 3000₽
   - Купон: 500₽ на Лисичкино
   - Бюджет: 50,000₽ (Миндаль платит 100%)
   - Сообщение партнеру: "Привет! Хочу направить к тебе клиентов..."

2. **Отправка партнеру**
   - Нажимает [Отправить запрос]
   - Лисичкино получает email + push + Telegram

3. **Лисичкино рассматривает**
   - Видит в своей панели "Новое предложение"
   - Изучает условия
   - Видит прогноз: +50-100 новых клиентов
   - Решение: [Одобрить]

4. **Активация**
   - Предложение автоматически активируется
   - Клиенты Миндаль начинают получать купоны

5. **Результат через месяц**
   - 45 клиентов получили купон
   - 16 использовали (конверсия 35%)
   - Выручка Лисичкино: +48,000₽
   - Средний чек: 3,000₽
   - ✅ Обе довольны, решают сделать циклическую цепочку

---

### Сценарий 3: Системная цепочка от админа

**Участники:** Администратор платформы

**Задача:** Повысить вовлеченность новых участниц

**Шаги:**

1. **Анализ данных**
   - Видит: новые участницы часто не делают вторую покупку
   - Решение: создать мотивационную цепочку

2. **Создание цепочки**
   - Заходит в админ-панель
   - [Создать системную цепочку]
   - Название: "Путь новичка"
   - Шаг 1: Лисичкино (покупка от 2000₽) → купон 700₽ на Миндаль
   - Шаг 2: Миндаль (использовал купон) → купон 500₽ на Стим
   - Шаг 3: Стим (использовал купон) → временный VIP-статус на 30 дней
   - Финансирование: Платформа (бюджет 300,000₽)
   - Целевая аудитория: Новые участницы (< 30 дней)

3. **Публикация**
   - Запускает цепочку 01.12.2025
   - Уведомляет всех новых участниц

4. **Мониторинг**
   - Неделя 1: 45 человек начали цепочку
   - Неделя 2: 27 перешли на шаг 2
   - Неделя 3: 18 завершили цепочку

5. **Результат через месяц**
   - 60 участниц завершили цепочку
   - Расход: 180,000₽
   - Прогноз LTV: 600,000₽
   - ROI: 3.3x
   - ✅ Цепочка эффективна, продлевают на январь

---

### Сценарий 4: Пакетное предложение

**Участники:** 3 собственницы (Стим + Миндаль + Оптика)

**Задача:** Создать комплексный пакет "Smile & Style"

**Шаги:**

1. **Инициатива**
   - Стоматология Стим предлагает идею
   - Обсуждают в общем Telegram-чате

2. **Создание пакета**
   - Стим создает в панели "Пакетное предложение"
   - Добавляет участников:
     - Стим: Профчистка зубов (5000₽) - 40% от пакета
     - Миндаль: Стрижка + укладка (3500₽) - 35%
     - Оптика: Диагностика зрения (2500₽) - 25%
   - Итого: 11,000₽ → Пакет: 8,800₽ (скидка 20%)
   - Условия: Услуги использовать в течение 60 дней

3. **Согласование**
   - Миндаль получает запрос → [Одобряю]
   - Оптика получает запрос → [Одобряю]
   - Все 3 одобрили → На модерацию админу

4. **Модерация**
   - Админ проверяет:
     - Скидка 20% - адекватная ✓
     - Все бизнесы подтвердили ✓
     - Распределение выручки корректное ✓
   - Решение: [Одобрить]

5. **Публикация**
   - Пакет активен
   - Показывается VIP+ клиентам
   - Продано: 12 пакетов за месяц

6. **Результат**
   - Выручка: 105,600₽
   - Распределение:
     - Стим: 42,240₽
     - Миндаль: 36,960₽
     - Оптика: 26,400₽
   - Каждый бизнес получил новых клиентов
   - ✅ Решают сделать серию пакетов

---

## ЗАКЛЮЧЕНИЕ

### Ключевые принципы конструктора

```yaml
Простота:
  - Минимум кликов для создания
  - Визуальные редакторы
  - Автоматические подсказки

Прозрачность:
  - Прогнозы ROI
  - Понятные метрики
  - Детальная аналитика

Гибкость:
  - 5 типов предложений
  - Комбинирование условий
  - Настройка под любую задачу

Контроль:
  - Система одобрений
  - Модерация сложных цепочек
  - Возможность отмены

Win-Win:
  - Аналитика связок
  - Рекомендации на основе данных
  - Справедливое распределение выгод
```

---

**ГОТОВО К РЕАЛИЗАЦИИ** 🚀

Этот документ содержит полную механику создания, управления и аналитики предложений для проекта "Свой Круг". Все UI/UX описания можно передать дизайнеру, а схемы БД и API - разработчику.
