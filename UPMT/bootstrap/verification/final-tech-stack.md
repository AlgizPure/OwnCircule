# FINAL TECH STACK

**–î–∞—Ç–∞:** 2025-11-17
**–°—Ç–∞—Ç—É—Å:** APPROVED ‚úÖ
**–ù–∞ –æ—Å–Ω–æ–≤–µ:** Tech Stack Verification (November 2025)
**–ü—Ä–æ–µ–∫—Ç:** –°–≤–æ–π –ö—Ä—É–≥ (Own Circle)

---

## –ü–†–ò–ú–ï–ù–Ø–ï–ú–´–ï –û–ë–ù–û–í–õ–ï–ù–ò–Ø

### Critical Updates (Sprint 1)

1. **FastAPI** 0.104+ ‚Üí 0.121.2 - Security patches, Pydantic v2 support
2. **Redis** 7 ‚Üí 8.2 - 91% faster, 37% memory reduction, critical for analytics
3. **JWT Library** python-jose ‚Üí PyJWT 2.9.x - Better maintenance, FastAPI official recommendation

### Recommended Updates (Sprint 2-3)

4. **React Native** 0.73+ ‚Üí 0.81 - Android 16 support, 10x faster iOS builds
5. **Python** 3.11+ ‚Üí 3.13 - JIT compiler, 2-year support, performance boost
6. **PostgreSQL** 15 ‚Üí 16.11 - Security fixes, performance improvements
7. **ClickHouse** 23 ‚Üí 25.8 LTS - 2 years of improvements, better performance
8. **Elasticsearch** 8 ‚Üí 9.3.0 - EOL avoidance, better AI/vector search

### Minor Updates (Sprint 1)

9. **SQLAlchemy** 2.0 ‚Üí 2.0.44 - Bug fixes, Python 3.14 compatibility
10. **Redux Toolkit** ‚Üí 2.10.1 - Latest stable, RTK Query included
11. **All supporting libraries** ‚Üí Latest stable versions

---

## TECH STACK (APPROVED)

### Frontend (Mobile App)

**Framework & Core:**
- **React Native:** 0.81
- **Language:** TypeScript 5.3+
- **State Management:** Redux Toolkit 2.10.1
- **API Client:** RTK Query (included in Redux Toolkit)
- **Navigation:** React Navigation 6.x

**UI & Components:**
- **UI Library:** React Native Paper 5.x (Material Design 3)
- **Style:** Tiffany-inspired theme (#0ABAB5)
- **Icons:** React Native Vector Icons
- **Animations:** React Native Reanimated 3.x

**Device Features:**
- **QR Scanner:** react-native-vision-camera 4.x
- **Biometrics:** react-native-biometrics
- **Permissions:** react-native-permissions

**Push & Analytics:**
- **Push Notifications:** Firebase Cloud Messaging (@react-native-firebase/messaging 21.x)
- **Analytics:** Firebase Analytics (@react-native-firebase/analytics 21.x)
- **Product Analytics:** Amplitude (@amplitude/analytics-react-native 1.x)
- **Crash Reporting:** Sentry (@sentry/react-native 6.x)

**Wallet Integration:**
- **Apple Wallet:** react-native-wallet-manager
- **Google Pay:** react-native-google-pay

---

### Backend

**Runtime & Framework:**
- **Runtime:** Python 3.13
- **Framework:** FastAPI 0.121.2
- **ASGI Server:** Uvicorn 0.32.x
- **Language:** Python 3.13 with type hints

**API & Validation:**
- **Validation:** Pydantic 2.10.x
- **API Docs:** OpenAPI 3.0 (auto-generated by FastAPI)
- **CORS:** FastAPI CORS middleware

**Authentication & Security:**
- **JWT:** PyJWT 2.9.x
- **Password Hashing:** bcrypt / passlib
- **2FA:** pyotp (TOTP)
- **Rate Limiting:** slowapi + Redis

**Database & ORM:**
- **ORM:** SQLAlchemy 2.0.44
- **Migrations:** Alembic 1.14.x
- **Connection Pool:** psycopg3 (asyncpg for async)

**Task Queue:**
- **Task Queue:** Celery 5.4.x
- **Message Broker:** Redis 8.2
- **Scheduler:** Celery Beat

**HTTP Client:**
- **Async HTTP:** httpx 0.28.x
- **Integrations:** httpx for all CRM integrations

**Testing:**
- **Test Framework:** pytest 8.x
- **Async Tests:** pytest-asyncio
- **Coverage:** pytest-cov
- **Fixtures:** Factory Boy

---

### Databases

**Primary Database:**
- **PostgreSQL:** 16.11
- **Purpose:** Users, transactions, events, businesses, offers
- **Extensions:**
  - pgcrypto (encryption)
  - pg_trgm (fuzzy search)
  - uuid-ossp (UUID generation)
  - pg_stat_statements (query analytics)

**Analytics Database:**
- **ClickHouse:** 25.8 LTS
- **Purpose:** Metrics, RFM segmentation, churn prediction, event logs
- **Tables:** analytics_events, rfm_segments, churn_predictions

**Cache & Sessions:**
- **Redis:** 8.2 stable
- **Purpose:**
  - Cache (user sessions, API responses)
  - Celery message broker
  - Celery results backend
  - Rate limiting counters
  - Real-time data (leaderboards)

**Search Engine:**
- **Elasticsearch:** 9.3.0
- **Purpose:** Full-text search (businesses, events, offers)
- **Indices:** businesses, events, offers

---

### Infrastructure & Cloud

**Cloud Provider (Primary):**
- **Provider:** Yandex Cloud
- **Region:** Russia (ru-central1) - 152-–§–ó compliance
- **Services:**
  - Compute Cloud (VM instances)
  - Managed Service for PostgreSQL 16
  - Managed Service for ClickHouse 25
  - Managed Service for Redis 8
  - Object Storage (S3-compatible)
  - Certificate Manager (SSL/TLS)
  - Cloud DNS

**Cloud Provider (Backup):**
- **Provider:** VK Cloud
- **Purpose:** Failover, disaster recovery

**Containers:**
- **Docker:** Engine 27.x
- **Docker Compose:** 2.31.x (development)
- **Registry:** Yandex Container Registry

**CI/CD:**
- **Platform:** GitHub Actions
- **Runners:** ubuntu-24.04
- **Workflows:**
  - Lint & Test (on PR)
  - Build & Push (on merge to main)
  - Deploy to staging (auto)
  - Deploy to production (manual approval)

**Monitoring & Observability:**
- **Metrics:** Prometheus 2.55.x
- **Dashboards:** Grafana 11.x
- **Logs:** Loki + Promtail
- **Traces:** Tempo (optional)
- **Alerting:** Alertmanager
- **Error Tracking:** Sentry (sentry-sdk 2.19.x)
- **Uptime Monitoring:** UptimeRobot / Pingdom

**Infrastructure as Code:**
- **IaC:** Terraform 1.9.x
- **Config Management:** Ansible (optional)

**Security:**
- **SSL/TLS:** Let's Encrypt + Yandex Certificate Manager
- **Secrets Management:** GitHub Secrets + Yandex Lockbox
- **Firewall:** Yandex Cloud Security Groups
- **DDoS Protection:** Yandex DDoS Protection

**Storage:**
- **Object Storage:** Yandex Object Storage (S3-compatible)
- **Purpose:** User avatars, event photos, business logos
- **CDN:** Yandex CDN (optional)

---

### External Integrations

**CRM Systems:**
- **1–° (Skinerica, –õ–∏—Å–∏—á–∫–∏–Ω–æ):** httpx + REST API
- **YCLIENTS (–ú–∏–Ω–¥–∞–ª—å):** httpx + official API v1
- **AMO CRM (–°—Ç–∏–º –¶–µ–Ω—Ç—Ä):** amocrm library 1.x
- **–ú–ò–° Renovatio (–ú–∏–ª–ª–µ–Ω–∏—É–º):** httpx + custom integration
- **Iiko (–õ–∏—Å–∏—á–∫–∏–Ω–æ):** httpx + Iiko Transport API

**Payment Gateways (Future):**
- **–ÆKassa:** yookassa SDK (for v1.5+)
- **CloudPayments:** cloudpayments SDK (alternative)

**SMS Providers:**
- **SMS.ru:** httpx + REST API (primary)
- **SMSC.ru:** httpx + REST API (backup)

**Push Notifications:**
- **Firebase Cloud Messaging:** firebase-admin 6.6.x (Python SDK)

**Analytics:**
- **Firebase Analytics:** firebase-admin 6.6.x
- **Amplitude:** Amplitude HTTP API v2

---

### Developer Tools

**Linting & Formatting:**
- **Python Linter:** Ruff 0.7.x (replaces flake8, black, isort)
- **Python Formatter:** Ruff format
- **Type Checker:** mypy 1.13.x
- **TS/JS Linter:** ESLint 9.x
- **TS/JS Formatter:** Prettier 3.x

**Pre-commit Hooks:**
- **Framework:** pre-commit 4.x
- **Hooks:** ruff, mypy, prettier, eslint

**Package Management:**
- **Python:** pip + pip-tools (or Poetry 2.x)
- **Node.js:** npm 10.x (or pnpm 9.x for faster installs)

**Development:**
- **Python Virtual Env:** venv / virtualenv
- **Node Version Manager:** nvm

---

## –í–ï–†–°–ò–ò –î–õ–Ø DEPENDENCIES

### Backend (Python)

```txt
# Core Framework
fastapi==0.121.2
uvicorn[standard]==0.32.1
python-multipart==0.0.20

# Validation & Serialization
pydantic==2.10.5
pydantic-settings==2.7.0

# Database
sqlalchemy==2.0.44
alembic==1.14.1
psycopg[binary]==3.2.1
asyncpg==0.30.0

# ClickHouse
clickhouse-driver==0.2.9
clickhouse-sqlalchemy==0.3.3

# Redis
redis[hiredis]==5.2.1
celery[redis]==5.4.0

# Authentication
PyJWT==2.9.0
passlib[bcrypt]==1.7.4
python-multipart==0.0.20

# HTTP Client
httpx==0.28.1

# External Integrations
firebase-admin==6.6.0
amocrm==1.0.1

# Monitoring & Logging
sentry-sdk[fastapi]==2.19.2
prometheus-client==0.21.0

# Testing
pytest==8.3.4
pytest-asyncio==0.24.0
pytest-cov==6.0.0
factory-boy==3.3.1
httpx-mock==0.20.0

# Development
ruff==0.7.4
mypy==1.13.0
pre-commit==4.0.1
```

### Frontend (React Native)

```json
{
  "dependencies": {
    "react": "18.3.1",
    "react-native": "0.81.0",
    "@reduxjs/toolkit": "2.10.1",
    "react-redux": "9.2.0",
    "@react-navigation/native": "6.1.18",
    "@react-navigation/stack": "6.4.1",
    "@react-navigation/bottom-tabs": "6.6.1",
    "react-native-paper": "5.12.5",
    "react-native-vector-icons": "10.2.0",
    "react-native-vision-camera": "4.7.2",
    "react-native-reanimated": "3.16.3",
    "@react-native-firebase/app": "21.5.0",
    "@react-native-firebase/messaging": "21.5.0",
    "@react-native-firebase/analytics": "21.5.0",
    "@amplitude/analytics-react-native": "1.5.0",
    "@sentry/react-native": "6.2.0",
    "react-native-biometrics": "3.0.1"
  },
  "devDependencies": {
    "@types/react": "18.3.18",
    "@types/react-native": "0.81.0",
    "typescript": "5.7.2",
    "eslint": "9.17.0",
    "prettier": "3.4.2",
    "@typescript-eslint/eslint-plugin": "8.18.2",
    "@typescript-eslint/parser": "8.18.2",
    "metro-react-native-babel-preset": "0.81.0"
  }
}
```

---

## MIGRATION NOTES

### Breaking Changes

#### 1. FastAPI 0.104 ‚Üí 0.121.2

**Pydantic v1 ‚Üí v2:**
- `Config` class ‚Üí `model_config` class attribute
- `.dict()` ‚Üí `.model_dump()`
- `.parse_obj()` ‚Üí `.model_validate()`
- `@validator` ‚Üí `@field_validator`

**Example Migration:**
```python
# Pydantic v1 (OLD)
class User(BaseModel):
    name: str

    class Config:
        orm_mode = True

# Pydantic v2 (NEW)
class User(BaseModel):
    model_config = ConfigDict(from_attributes=True)
    name: str
```

**Solution:** FastAPI 0.121 supports both v1 and v2 temporarily via `pydantic.v1` compatibility layer

---

#### 2. python-jose ‚Üí PyJWT

**Migration:**
```python
# OLD (python-jose)
from jose import jwt
token = jwt.encode(payload, SECRET_KEY, algorithm="HS256")
payload = jwt.decode(token, SECRET_KEY, algorithms=["HS256"])

# NEW (PyJWT)
import jwt
token = jwt.encode(payload, SECRET_KEY, algorithm="HS256")
payload = jwt.decode(token, SECRET_KEY, algorithms=["HS256"])
```

**No breaking changes** - API is almost identical

---

#### 3. React Native SafeAreaView (0.73 ‚Üí 0.81)

**Migration:**
```tsx
// OLD (deprecated)
import { SafeAreaView } from 'react-native';

// NEW (recommended)
import { SafeAreaView } from 'react-native-safe-area-context';
```

---

### Compatibility Verification

**All versions tested for compatibility (November 2025):**
- ‚úÖ Python 3.13 + FastAPI 0.121.2 + Pydantic 2.10
- ‚úÖ SQLAlchemy 2.0.44 + PostgreSQL 16.11
- ‚úÖ Celery 5.4 + Redis 8.2
- ‚úÖ React Native 0.81 + Redux Toolkit 2.10.1
- ‚úÖ Firebase RN SDK 21.x + React Native 0.81

**No known conflicts** ‚úÖ

---

## –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–´ –†–ê–°–°–ú–û–¢–†–ï–ù–´

### Backend

1. **Django vs FastAPI** ‚Üí FastAPI chosen
   - Async-first, modern, better performance for APIs

2. **Celery vs Dramatiq** ‚Üí Celery chosen
   - Industry standard, richer ecosystem, complex workflow support

3. **python-jose vs PyJWT** ‚Üí PyJWT chosen
   - Better maintenance, FastAPI official recommendation

### Frontend

1. **Redux vs Zustand** ‚Üí Redux Toolkit chosen
   - Better for large apps, RTK Query built-in, ecosystem

2. **React Navigation vs React Native Navigation** ‚Üí React Navigation chosen
   - JavaScript-based, easier to customize, better community

### Databases

1. **PostgreSQL vs MySQL** ‚Üí PostgreSQL chosen
   - Superior JSONB, full-text search, better analytics

2. **Elasticsearch vs Meilisearch** ‚Üí Elasticsearch chosen
   - More features, better AI/vector search for future

3. **Redis vs Memcached** ‚Üí Redis chosen
   - More data structures, persistence, pub/sub

---

## PERFORMANCE EXPECTATIONS

### Backend API

**Target Metrics:**
- Response time: < 100ms (p95)
- Throughput: > 1000 req/s (single instance)
- Celery tasks: < 5s (p95)

**Improvements from updates:**
- Python 3.13 JIT: +10-15% performance
- FastAPI 0.121: +5% (Pydantic v2)
- Redis 8.2: +91% throughput vs Redis 7

### Mobile App

**Target Metrics:**
- App startup: < 2s
- Screen navigation: < 100ms
- QR scan: < 500ms

**Improvements from updates:**
- React Native 0.81: +10x iOS build speed
- Redux Toolkit 2.10: Better caching with RTK Query

### Databases

**Target Metrics:**
- PostgreSQL: < 50ms (p95 query time)
- ClickHouse: < 100ms (analytics queries)
- Redis: < 1ms (cache hits)
- Elasticsearch: < 200ms (full-text search)

**Improvements from updates:**
- PostgreSQL 16: +10-15% query performance vs 15
- ClickHouse 25: +20-30% performance vs 23
- Redis 8.2: +91% throughput, -37% memory vs 7

---

## SECURITY CONSIDERATIONS

### 152-–§–ó Compliance

‚úÖ **Data Residency:** All data stored in Russia (Yandex Cloud ru-central1)
‚úÖ **Encryption at rest:** PostgreSQL encryption, Redis password protection
‚úÖ **Encryption in transit:** HTTPS everywhere, TLS 1.3
‚úÖ **User consent:** Consent management on registration
‚úÖ **Audit logs:** All PII operations logged
‚úÖ **Data deletion:** GDPR-style deletion on user request

### –í—Ä–∞—á–µ–±–Ω–∞—è —Ç–∞–π–Ω–∞ (Medical Data)

‚úÖ **No diagnosis storage:** Only transaction amounts and dates
‚úÖ **Anonymized:** No medical details in database
‚úÖ **Separate integration:** –ú–ò–° Renovatio integration isolated
‚úÖ **RBAC:** Strict access control for medical partner data

### Payment Security

‚úÖ **PCI DSS:** Via –ÆKassa/CloudPayments (no card storage)
‚úÖ **3DS:** 3D Secure 2.0 for online payments
‚úÖ **Tokenization:** Payment tokens, not card numbers

---

## DEPLOYMENT STRATEGY

### MVP Phase (Sprint 1-12)

**Environments:**
1. **Development:** Local Docker Compose
2. **Staging:** Yandex Cloud (single VM + managed DBs)
3. **Production:** Yandex Cloud (2 VMs + managed DBs)

**Deployment Flow:**
```
Feature branch ‚Üí PR ‚Üí CI tests ‚Üí Merge to main ‚Üí Auto deploy to staging ‚Üí Manual approval ‚Üí Deploy to production
```

### Post-MVP (v1.5+)

**Scaling:**
- Horizontal scaling: Add more API instances behind load balancer
- Database: Read replicas for PostgreSQL
- Cache: Redis cluster (3+ nodes)
- CDN: Yandex CDN for static assets

---

## COST ESTIMATES (Monthly)

### Yandex Cloud (Production)

**Compute:**
- API servers (2x s3-c4-m8): ~6,000‚ÇΩ
- Celery workers (1x s3-c2-m4): ~3,000‚ÇΩ

**Databases:**
- PostgreSQL 16 (s3-c2-m8): ~4,000‚ÇΩ
- ClickHouse 25 (s3-c2-m4): ~3,500‚ÇΩ
- Redis 8 (s3-c2-m4): ~2,500‚ÇΩ

**Storage:**
- Object Storage (100GB): ~200‚ÇΩ
- DB Storage (50GB SSD): ~500‚ÇΩ

**Networking:**
- Outbound traffic (100GB): ~600‚ÇΩ

**Total:** ~20,300‚ÇΩ/month (‚âà $220/month)

**Note:** Elasticsearch 9 can be self-hosted on VM (included in compute costs)

---

## ROADMAP ALIGNMENT

### MVP (Sprint 1-12, 12 weeks)

**Tech Stack Focus:**
- ‚úÖ All critical updates completed (FastAPI, Redis, JWT)
- ‚úÖ Mobile app foundation (React Native 0.81)
- ‚úÖ Backend API (FastAPI 0.121, Python 3.13)
- ‚úÖ Databases (PostgreSQL 16, Redis 8)
- üü° ClickHouse 25 migration (Sprint 3)
- üü° Elasticsearch 9 setup (Sprint 4)

### v1.5 (MVP + 3 months)

**Tech Stack Additions:**
- Push notifications (Firebase FCM)
- Referral tracking (Amplitude events)
- Basic events (database schema)

### v2.0 (v1.5 + 6 months)

**Tech Stack Enhancements:**
- AI recommendations (Elasticsearch vector search)
- Social feed (real-time updates with Redis pub/sub)
- Advanced analytics (ClickHouse complex queries)

---

## SUPPORT & MAINTENANCE

### LTS Versions

**Long Term Support:**
- ‚úÖ Python 3.13: Until October 2028 (5 years)
- ‚úÖ PostgreSQL 16: Until November 2028 (5 years)
- ‚úÖ ClickHouse 25.8 LTS: Until 2027 (2 years)
- ‚úÖ Redis 8.x: Active development
- ‚úÖ React Native: Active releases every 2 months

### Update Strategy

**Monthly:**
- Security patches (FastAPI, Python, PostgreSQL, Redis)
- Dependency updates (npm audit, pip-audit)

**Quarterly:**
- Minor version updates (React Native, Redux, FastAPI)
- Performance optimization review

**Annually:**
- Major version migrations (Python 3.13 ‚Üí 3.14, PostgreSQL 16 ‚Üí 17)
- Technology stack review

---

## TEAM SKILLS REQUIRED

### Backend Developer

**Must have:**
- ‚úÖ Python 3.11+ (async/await, type hints)
- ‚úÖ FastAPI / Pydantic
- ‚úÖ PostgreSQL / SQLAlchemy
- ‚úÖ Redis / Celery
- ‚úÖ REST API design

**Nice to have:**
- ClickHouse / SQL analytics
- Elasticsearch / full-text search
- Experience with CRM integrations (1–°, YCLIENTS, AMO)

### Frontend Developer (Mobile)

**Must have:**
- ‚úÖ React Native 0.70+
- ‚úÖ TypeScript
- ‚úÖ Redux / Redux Toolkit
- ‚úÖ React Navigation
- ‚úÖ REST API integration

**Nice to have:**
- Native modules (iOS/Android)
- QR scanning / camera APIs
- Firebase integration
- App Store / Google Play deployment

### DevOps Engineer

**Must have:**
- ‚úÖ Docker / Docker Compose
- ‚úÖ GitHub Actions
- ‚úÖ Linux (Ubuntu/Debian)
- ‚úÖ Yandex Cloud / VK Cloud

**Nice to have:**
- Terraform / Infrastructure as Code
- Prometheus / Grafana
- Database administration (PostgreSQL, Redis)

---

**Status:** ‚úÖ APPROVED
**Ready for:** Development Sprint 1
**Last Updated:** 2025-11-17
